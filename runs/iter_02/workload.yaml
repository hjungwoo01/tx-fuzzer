# workloads/iter_02.yaml
# Changes from previous iteration:
# - Focused contention on integer keys 1-3 (matching the live schema) using bounded rand_int generators.
# - Tilted mix toward writers (0.65) so more updates compete on hot keys.
# - Raised clients from 4 to 8 and added light barriers to increase overlap without overwhelming the DB.
# - Disabled repeated schema init for subsequent runs.

database:
  kind: postgres
  dsn: "postgres://postgres:postgres@txfuzz-pg:5432/postgres?sslmode=disable"

init_schema: false

workload:
  datatype: register
  transactions:
    - name: write-random
      isolation: "READ COMMITTED"
      timeout: "2s"
      steps:
        - sql: "UPDATE kv SET v=$1 WHERE k=$2"
          args:
            - rand_int: {min: 0, max: 1000000}
            - rand_int: {min: 1, max: 3}
          elle: {f: ":write", key: "$2"}
        - sql: "SELECT v FROM kv WHERE k=$1"
          args: ["$2"]
          elle: {f: ":read", key: "$1", value_from_result_col: 0}

    - name: read
      timeout: "1s"
      steps:
        - sql: "SELECT v FROM kv WHERE k=$1"
          args:
            - rand_int: {min: 1, max: 3}
          elle: {f: ":read", key: "$1", value_from_result_col: 0}

  mix:
    - txn: write-random
      weight: 0.65
    - txn: read
      weight: 0.35

scheduling:
  duration: "3s"
  clients: 8
  barrier_every: 3
  random_kill_pct: 0
  jitter_ms_min: 0
  jitter_ms_max: 0
